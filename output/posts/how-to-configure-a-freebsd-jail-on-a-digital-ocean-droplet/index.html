<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to configure a FreeBSD Jail on a Digital Ocean Droplet | kirkg.us</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Kirk Gleason">
<link rel="next" href="../building-an-openvpn-server-with-opnsense/" title="Building an OpenVPN Server with OPNSense" type="text/html">
<meta property="og:site_name" content="kirkg.us">
<meta property="og:title" content="How to configure a FreeBSD Jail on a Digital Ocean Droplet">
<meta property="og:url" content="https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/">
<meta property="og:description" content="One of the great things about FreeBSD is its long standing support for jails.
A jail is a way to run a process or set of processes in an environment that is
isolated from the host system. Processes cr">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-02-21T20:55:57-05:00">
<meta property="article:tag" content="digital-ocean">
<meta property="article:tag" content="FreeBSD">
<meta property="article:tag" content="jails">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="pf">
<meta property="article:tag" content="technology">
<link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
</head>
<body>

	<a href="#page-content" class="sr-only sr-only-focusable">
		Skip to main content
	</a>

	

    <section id="header"><a href="../../">
			<div class="logo">
					<div id="nologoimage">
						kirkg.us
					</div>
    		</div>
			</a>
    </section><section id="socialNav"><!-- Navigation Menu - on top on small screens, down the left on larger --><div class="navlinks">
			<a href="../../">
				<div id="titleauth">
    					kirkg.us<br> by Kirk Gleason
				</div>
			</a>

            <!-- Navigation links (hidden by default) -->
			<div id="navmenuitems">
				            <a href="../../index.html" title="Home">
                <span class="menuitemtext">Home</span>
                <span class="menuitemicon"><i class="fa fa-home"></i></span>
            </a>
            <a href="../../archive.html" title="Archives">
                <span class="menuitemtext">Archives</span>
                <span class="menuitemicon"><i class="fa fa-folder-open"></i></span>
            </a>
            <a href="../../categories/index.html" title="Tags">
                <span class="menuitemtext">Tags</span>
                <span class="menuitemicon"><i class="fa fa-tags"></i></span>
            </a>
            <a href="../../rss.xml" title="RSS">
                <span class="menuitemtext">RSS</span>
                <span class="menuitemicon"><i class="fa fa-rss"></i></span>
            </a>
            <a href="../" title="About me">
                <span class="menuitemtext">About me</span>
                <span class="menuitemicon"><i class="fa fa-user"></i></span>
            </a>
            <a href="https://www.linkedin.com/in/kirk-gleason/" title="LinkedIn">
                <span class="menuitemtext">LinkedIn</span>
                <span class="menuitemicon"><i class="fab fa-linkedin"></i></span>
            </a>
            <a href="https://github.com/kgleason" title="Github">
                <span class="menuitemtext">Github</span>
                <span class="menuitemicon"><i class="fab fa-github"></i></span>
            </a>
            <a href="https://www.gitlab.com/kgleason" title="GitLab">
                <span class="menuitemtext">GitLab</span>
                <span class="menuitemicon"><i class="fab fa-gitlab"></i></span>
            </a>
    
    

			</div>

            <!-- "Hamburger menu" / "Bar icon" to toggle the navigation links -->
			<a href="javascript:void(0);" id="hamburger" class="icon" onclick="toggleNav()">
				<i class="fa fa-bars">
				</i>
			</a>
		</div>

	</section><section class="page-content"><div class="content" rel="main">
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">How to configure a FreeBSD Jail on a Digital Ocean Droplet</a></h1>

        <div class="metadata">
            <p class="dateline"><a href="." rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2015-02-21T20:55:57-05:00" itemprop="datePublished" title="2015-02-21 20:55">2015-02-21 20:55</time></a></p>

                    <p class="sourceline"><a href="index.rst" class="sourcelink"><i class="fa fa-file-code"></i> Source</a></p>

            
                <div class="tags">
<h3 class="metadata-title">
<i class="fa fa-tags"></i> Tags:</h3>
        <ul itemprop="keywords" class="tags-ul">
<li><a class="tag p-category" href="../../categories/digital-ocean/" rel="tag">digital-ocean</a></li>
            <li><a class="tag p-category" href="../../categories/freebsd/" rel="tag">FreeBSD</a></li>
            <li><a class="tag p-category" href="../../categories/jails/" rel="tag">jails</a></li>
            <li><a class="tag p-category" href="../../categories/nginx/" rel="tag">nginx</a></li>
            <li><a class="tag p-category" href="../../categories/pf/" rel="tag">pf</a></li>
            <li><a class="tag p-category" href="../../categories/technology/" rel="tag">technology</a></li>
        </ul>
</div>

        </div>
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>One of the great things about FreeBSD is its long standing support for <a class="reference external" href="http://www.freebsd.org/doc/handbook/jails.html">jails</a>.
A jail is a way to run a process or set of processes in an environment that is
isolated from the host system. Processes created inside a jail cannot access files
outside of that jail.</p>
<p>There are a host of reasons why you might want to run your services in jails, but
the primary reason is that it allows you to run disparate services without having
to worry about a flaw in one service allowing access to another service. For example,
jails will allow you to run a mail server and a web server on the same Droplet
without having to be overly concerned that a vulnerability in your web site could
expose the data in your mail server.</p>
<p>Over the course of this article, you will take a newly minted FreeBSD Droplet, do
some initial configuration, set up a jail, and install a simple web server
inside the jail.</p>
<p>In the end, you will be setting up a firewall to protect the host system. This
tutorial will be using the <a class="reference external" href="http://www.freebsd.org/doc/handbook/firewalls-pf.html">PF</a> firewall that is included in FreeBSD. Aside from
configuring a firewall, you will also be making some tweaks to the default shell
as well as making some changes to the configuration of some of the default services.</p>
<!-- TEASER_END -->
<div class="line-block">
<div class="line"><br></div>
</div>
<section id="the-default-editor-and-shell-prompt"><h2>The default editor and shell prompt</h2>
<p>By default, FreeBSD uses <em>tcsh</em> as it's default shell, and <em>vi</em> as the default
editor. Both are pretty spartan, so in this optional section, you'll be updating
the shell prompt and the default editor. Since you'll probably want a better
editor in order to fix the shell prompt, we'll start with the editor.</p>
<section id="a-better-editor"><h3>A better editor</h3>
<p>The following command will install a version of <em>vim</em> that does not require X11.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_6e9fdacce79f4439842d2b25847911f8-1" name="rest_code_6e9fdacce79f4439842d2b25847911f8-1" href="#rest_code_6e9fdacce79f4439842d2b25847911f8-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>vim-lite
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Since it is the first time that the <em>pkg</em> command has been run, it is going to
do some initial setup &amp; checks. If you've run <em>pkg</em> before, then your output may
look different.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_a03da1dfb64644dcae0758543bf4f204-1" name="rest_code_a03da1dfb64644dcae0758543bf4f204-1" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-1"></a>&gt; sudo pkg install vim-lite
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-2" name="rest_code_a03da1dfb64644dcae0758543bf4f204-2" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-2"></a>Updating FreeBSD repository catalogue...
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-3" name="rest_code_a03da1dfb64644dcae0758543bf4f204-3" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-3"></a>Fetching meta.txz: 100%   944 B   0.9k/s    00:01
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-4" name="rest_code_a03da1dfb64644dcae0758543bf4f204-4" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-4"></a>Fetching packagesite.txz: 100%    5 MB   1.8M/s    00:03
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-5" name="rest_code_a03da1dfb64644dcae0758543bf4f204-5" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-5"></a>Processing entries: 100%
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-6" name="rest_code_a03da1dfb64644dcae0758543bf4f204-6" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-6"></a>FreeBSD repository update completed. 23992 packages processed
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-7" name="rest_code_a03da1dfb64644dcae0758543bf4f204-7" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-7"></a>New version of pkg detected; it needs to be installed first.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-8" name="rest_code_a03da1dfb64644dcae0758543bf4f204-8" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-8"></a>The following 1 packages will be affected (of 0 checked):
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-9" name="rest_code_a03da1dfb64644dcae0758543bf4f204-9" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-9"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-10" name="rest_code_a03da1dfb64644dcae0758543bf4f204-10" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-10"></a>Installed packages to be UPGRADED:
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-11" name="rest_code_a03da1dfb64644dcae0758543bf4f204-11" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-11"></a>    pkg: 1.4.4 -&gt; 1.4.12
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-12" name="rest_code_a03da1dfb64644dcae0758543bf4f204-12" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-12"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-13" name="rest_code_a03da1dfb64644dcae0758543bf4f204-13" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-13"></a>The process will require 23 KB more space.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-14" name="rest_code_a03da1dfb64644dcae0758543bf4f204-14" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-14"></a>2 MB to be downloaded.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-15" name="rest_code_a03da1dfb64644dcae0758543bf4f204-15" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-15"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-16" name="rest_code_a03da1dfb64644dcae0758543bf4f204-16" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-16"></a>Proceed with this action? [y/N]: y
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-17" name="rest_code_a03da1dfb64644dcae0758543bf4f204-17" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-17"></a>Fetching pkg-1.4.12.txz: 100%    2 MB   1.2M/s    00:02
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-18" name="rest_code_a03da1dfb64644dcae0758543bf4f204-18" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-18"></a>Checking integrity... done (0 conflicting)
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-19" name="rest_code_a03da1dfb64644dcae0758543bf4f204-19" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-19"></a>[1/1] Upgrading pkg from 1.4.4 to 1.4.12...
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-20" name="rest_code_a03da1dfb64644dcae0758543bf4f204-20" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-20"></a>[1/1] Extracting pkg-1.4.12: 100%
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-21" name="rest_code_a03da1dfb64644dcae0758543bf4f204-21" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-21"></a>Message for pkg-1.4.12:
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-22" name="rest_code_a03da1dfb64644dcae0758543bf4f204-22" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-22"></a> If you are upgrading from the old package format, first run:
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-23" name="rest_code_a03da1dfb64644dcae0758543bf4f204-23" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-23"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-24" name="rest_code_a03da1dfb64644dcae0758543bf4f204-24" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-24"></a>  # pkg2ng
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-25" name="rest_code_a03da1dfb64644dcae0758543bf4f204-25" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-25"></a>Updating FreeBSD repository catalogue...
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-26" name="rest_code_a03da1dfb64644dcae0758543bf4f204-26" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-26"></a>FreeBSD repository is up-to-date.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-27" name="rest_code_a03da1dfb64644dcae0758543bf4f204-27" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-27"></a>All repositories are up-to-date.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-28" name="rest_code_a03da1dfb64644dcae0758543bf4f204-28" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-28"></a>The following 1 packages will be affected (of 0 checked):
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-29" name="rest_code_a03da1dfb64644dcae0758543bf4f204-29" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-29"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-30" name="rest_code_a03da1dfb64644dcae0758543bf4f204-30" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-30"></a>New packages to be INSTALLED:
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-31" name="rest_code_a03da1dfb64644dcae0758543bf4f204-31" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-31"></a>    vim-lite: 7.4.591
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-32" name="rest_code_a03da1dfb64644dcae0758543bf4f204-32" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-32"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-33" name="rest_code_a03da1dfb64644dcae0758543bf4f204-33" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-33"></a>The process will require 20 MiB more space.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-34" name="rest_code_a03da1dfb64644dcae0758543bf4f204-34" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-34"></a>5 MiB to be downloaded.
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-35" name="rest_code_a03da1dfb64644dcae0758543bf4f204-35" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-35"></a>
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-36" name="rest_code_a03da1dfb64644dcae0758543bf4f204-36" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-36"></a>Proceed with this action? [y/N]: y
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-37" name="rest_code_a03da1dfb64644dcae0758543bf4f204-37" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-37"></a>Fetching vim-lite-7.4.591.txz: 100%    5 MiB   1.6MB/s    00:03
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-38" name="rest_code_a03da1dfb64644dcae0758543bf4f204-38" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-38"></a>Checking integrity... done (0 conflicting)
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-39" name="rest_code_a03da1dfb64644dcae0758543bf4f204-39" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-39"></a>[1/1] Installing vim-lite-7.4.591...
<a id="rest_code_a03da1dfb64644dcae0758543bf4f204-40" name="rest_code_a03da1dfb64644dcae0758543bf4f204-40" href="#rest_code_a03da1dfb64644dcae0758543bf4f204-40"></a>[1/1] Extracting vim-lite-7.4.591: 100%
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>In order to get tcsh to see the newly installed package, you'll need to rehash
the path:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_b6e4ee4e776d40738930488b04e8b44f-1" name="rest_code_b6e4ee4e776d40738930488b04e8b44f-1" href="#rest_code_b6e4ee4e776d40738930488b04e8b44f-1"></a>rehash
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>The rehash command should exit with no output.</p>
</section><section id="a-more-helpful-shell-prompt"><h3>A more helpful shell prompt</h3>
<p>FreeBSD include a sample csh configuration file that is an excellent starting
off point. You'll need to grab a copy of it in order to get started:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_8df38d5055164d52af8869b671befbf4-1" name="rest_code_8df38d5055164d52af8869b671befbf4-1" href="#rest_code_8df38d5055164d52af8869b671befbf4-1"></a>cp<span class="w"> </span>/usr/share/skel/dot.cshrc<span class="w"> </span>~/.cshrc
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Even though the default shell is tcsh, it will read ~/.cshrc, since tcsh inherits
a lot from the csh shell. Go ahead and open this file for editing:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_76430bb4c16747f1afe3514dc6281418-1" name="rest_code_76430bb4c16747f1afe3514dc6281418-1" href="#rest_code_76430bb4c16747f1afe3514dc6281418-1"></a>vim<span class="w"> </span>~/.cshrc
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>You'll probably want to change a couple of the defaults in this file. The default
editor is set to <em>vi</em> and the default pager is set to <em>more</em>. Go ahead and change
these to <em>vim</em> and <em>less</em> respectively. In order to do this, change</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_c27ba51ca4414bb193216fab743ecb76-1" name="rest_code_c27ba51ca4414bb193216fab743ecb76-1" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-1"></a>. . .
<a id="rest_code_c27ba51ca4414bb193216fab743ecb76-2" name="rest_code_c27ba51ca4414bb193216fab743ecb76-2" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-2"></a>
<a id="rest_code_c27ba51ca4414bb193216fab743ecb76-3" name="rest_code_c27ba51ca4414bb193216fab743ecb76-3" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-3"></a>setenv  EDITOR  vi
<a id="rest_code_c27ba51ca4414bb193216fab743ecb76-4" name="rest_code_c27ba51ca4414bb193216fab743ecb76-4" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-4"></a>setenv  PAGER   more
<a id="rest_code_c27ba51ca4414bb193216fab743ecb76-5" name="rest_code_c27ba51ca4414bb193216fab743ecb76-5" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-5"></a>
<a id="rest_code_c27ba51ca4414bb193216fab743ecb76-6" name="rest_code_c27ba51ca4414bb193216fab743ecb76-6" href="#rest_code_c27ba51ca4414bb193216fab743ecb76-6"></a>. . .
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>to</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_f770606020af49998dde4ac075fe5091-1" name="rest_code_f770606020af49998dde4ac075fe5091-1" href="#rest_code_f770606020af49998dde4ac075fe5091-1"></a>. . .
<a id="rest_code_f770606020af49998dde4ac075fe5091-2" name="rest_code_f770606020af49998dde4ac075fe5091-2" href="#rest_code_f770606020af49998dde4ac075fe5091-2"></a>
<a id="rest_code_f770606020af49998dde4ac075fe5091-3" name="rest_code_f770606020af49998dde4ac075fe5091-3" href="#rest_code_f770606020af49998dde4ac075fe5091-3"></a>setenv  EDITOR  vim
<a id="rest_code_f770606020af49998dde4ac075fe5091-4" name="rest_code_f770606020af49998dde4ac075fe5091-4" href="#rest_code_f770606020af49998dde4ac075fe5091-4"></a>setenv  PAGER   less
<a id="rest_code_f770606020af49998dde4ac075fe5091-5" name="rest_code_f770606020af49998dde4ac075fe5091-5" href="#rest_code_f770606020af49998dde4ac075fe5091-5"></a>
<a id="rest_code_f770606020af49998dde4ac075fe5091-6" name="rest_code_f770606020af49998dde4ac075fe5091-6" href="#rest_code_f770606020af49998dde4ac075fe5091-6"></a>. . .
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>You may not have noticed, but some of your keys may not work as expected -- the delete
is a great example. If you add the following chunk of code to the end of the file,
that problem will be fixed. This code will check the terminal type that is connected
and, if the terminal type is one that is expected, it will fix the whacky key bindings:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_68630b35aae540b6a577143688835ea0-1" name="rest_code_68630b35aae540b6a577143688835ea0-1" href="#rest_code_68630b35aae540b6a577143688835ea0-1"></a><span class="k">if</span><span class="w"> </span><span class="o">(</span><span class="nv">$term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"xterm"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">$term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"vt100"</span><span class="w"> </span><span class="se">\</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-2" name="rest_code_68630b35aae540b6a577143688835ea0-2" href="#rest_code_68630b35aae540b6a577143688835ea0-2"></a><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="nv">$term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"vt102"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">$term</span><span class="w"> </span>!~<span class="w"> </span><span class="s2">"con*"</span><span class="o">)</span><span class="w"> </span><span class="k">then</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-3" name="rest_code_68630b35aae540b6a577143688835ea0-3" href="#rest_code_68630b35aae540b6a577143688835ea0-3"></a><span class="w">          </span><span class="c1"># bind keypad keys for console, vt100, vt102, xterm</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-4" name="rest_code_68630b35aae540b6a577143688835ea0-4" href="#rest_code_68630b35aae540b6a577143688835ea0-4"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[1~"</span><span class="w"> </span>beginning-of-line<span class="w">  </span><span class="c1"># Home</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-5" name="rest_code_68630b35aae540b6a577143688835ea0-5" href="#rest_code_68630b35aae540b6a577143688835ea0-5"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[7~"</span><span class="w"> </span>beginning-of-line<span class="w">  </span><span class="c1"># Home rxvt</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-6" name="rest_code_68630b35aae540b6a577143688835ea0-6" href="#rest_code_68630b35aae540b6a577143688835ea0-6"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[2~"</span><span class="w"> </span>overwrite-mode<span class="w">     </span><span class="c1"># Ins</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-7" name="rest_code_68630b35aae540b6a577143688835ea0-7" href="#rest_code_68630b35aae540b6a577143688835ea0-7"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[3~"</span><span class="w"> </span>delete-char<span class="w">        </span><span class="c1"># Delete</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-8" name="rest_code_68630b35aae540b6a577143688835ea0-8" href="#rest_code_68630b35aae540b6a577143688835ea0-8"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[4~"</span><span class="w"> </span>end-of-line<span class="w">        </span><span class="c1"># End</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-9" name="rest_code_68630b35aae540b6a577143688835ea0-9" href="#rest_code_68630b35aae540b6a577143688835ea0-9"></a><span class="w">          </span>bindkey<span class="w"> </span><span class="s2">"\e[8~"</span><span class="w"> </span>end-of-line<span class="w">        </span><span class="c1"># End rxvt</span>
<a id="rest_code_68630b35aae540b6a577143688835ea0-10" name="rest_code_68630b35aae540b6a577143688835ea0-10" href="#rest_code_68630b35aae540b6a577143688835ea0-10"></a>endif
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>After the file has been saved, you can exit, you can make your shell read the new configuration
with:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_9ec91bdc3a0e4720aa3a53c1df6a0a8d-1" name="rest_code_9ec91bdc3a0e4720aa3a53c1df6a0a8d-1" href="#rest_code_9ec91bdc3a0e4720aa3a53c1df6a0a8d-1"></a>source ~/.cshrc
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Your prompt should change immediately:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_9ac2c5795834455b84a194ba52c714c6-1" name="rest_code_9ac2c5795834455b84a194ba52c714c6-1" href="#rest_code_9ac2c5795834455b84a194ba52c714c6-1"></a>freebsd@hostname:~ %
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
</section></section><section id="time-and-time-zones"><h2>Time and Time Zones</h2>
<section id="time-zone"><h3>Time Zone</h3>
<p>While not entirely necessary, keeping the time on your server correct is a
recommended best practice. Start by setting the timezone of our server:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_c32734f587e64669a49132b62b4fcaf1-1" name="rest_code_c32734f587e64669a49132b62b4fcaf1-1" href="#rest_code_c32734f587e64669a49132b62b4fcaf1-1"></a>sudo<span class="w"> </span>tzsetup
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Right off the bat, you should be prompted about the hardware clock on your machine:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<img alt="/images/FreeBSD_tzsetup.png" class="align-center" src="../../images/FreeBSD_tzsetup.png"><div class="line-block">
<div class="line"><br></div>
</div>
<p>You should choose "No" to set your clock to local time. Next you will be asked
to identify where in the world your server is located:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<img alt="/images/FreeBSD_regions.png" class="align-center" src="../../images/FreeBSD_regions.png"><div class="line-block">
<div class="line"><br></div>
</div>
<p>Next you'll need to be more specific about your region:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<img alt="/images/FreeBSD_subregions.png" class="align-center" src="../../images/FreeBSD_subregions.png"><div class="line-block">
<div class="line"><br></div>
</div>
<p>Finally, you'll be asked to choose a timezone:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<img alt="/images/FreeBSD_TimeZones.png" class="align-center" src="../../images/FreeBSD_TimeZones.png"><div class="line-block">
<div class="line"><br></div>
</div>
</section><section id="ntp-for-accurate-time-keeping"><h3>NTP for accurate time keeping</h3>
<p>With the time zone all configured, it's a good idea to configure NTP to keep the
time accurate. FreeBSD comes by default with an implementation of the ISC NTP
client, but for this tutorial, we'll be using <a class="reference external" href="http://openntpd.org">OpenNTPD</a> in order to keep the configuration
as simple as possible:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_40293866443d46eea1bc7386fe47edfc-1" name="rest_code_40293866443d46eea1bc7386fe47edfc-1" href="#rest_code_40293866443d46eea1bc7386fe47edfc-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>openntpd
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>OpenNTPd should install easily:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-1" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-1" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-1"></a>&gt; sudo pkg install openntpd
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-2" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-2" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-2"></a>Updating FreeBSD repository catalogue...
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-3" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-3" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-3"></a>FreeBSD repository is up-to-date.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-4" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-4" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-4"></a>All repositories are up-to-date.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-5" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-5" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-5"></a>The following 1 packages will be affected (of 0 checked):
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-6" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-6" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-6"></a>
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-7" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-7" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-7"></a>New packages to be INSTALLED:
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-8" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-8" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-8"></a>openntpd: 5.7p3,2
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-9" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-9" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-9"></a>
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-10" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-10" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-10"></a>The process will require 79 KiB more space.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-11" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-11" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-11"></a>36 KiB to be downloaded.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-12" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-12" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-12"></a>
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-13" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-13" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-13"></a>Proceed with this action? [y/N]: y
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-14" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-14" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-14"></a>Fetching openntpd-5.7p3,2.txz: 100%   36 KiB  37.4kB/s    00:01
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-15" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-15" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-15"></a>Checking integrity... done (0 conflicting)
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-16" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-16" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-16"></a>[1/1] Installing openntpd-5.7p3,2...
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-17" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-17" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-17"></a>===&gt; Creating users and/or groups.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-18" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-18" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-18"></a>Creating group '_ntp' with gid '123'.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-19" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-19" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-19"></a>Creating user '_ntp' with uid '123'.
<a id="rest_code_c2062c0d60dd436fa87e48c35c907ac7-20" name="rest_code_c2062c0d60dd436fa87e48c35c907ac7-20" href="#rest_code_c2062c0d60dd436fa87e48c35c907ac7-20"></a>[1/1] Extracting openntpd-5.7p3,2: 100%
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>You can make OpenNTPD start by default, and start the service manually with the
following commands:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_3a26d25412a54566a8a11709d960c98f-1" name="rest_code_3a26d25412a54566a8a11709d960c98f-1" href="#rest_code_3a26d25412a54566a8a11709d960c98f-1"></a>sudo<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s1">'echo "openntpd_enable=\"YES\"" &gt;&gt; /etc/rc.conf'</span>
<a id="rest_code_3a26d25412a54566a8a11709d960c98f-2" name="rest_code_3a26d25412a54566a8a11709d960c98f-2" href="#rest_code_3a26d25412a54566a8a11709d960c98f-2"></a>sudo<span class="w"> </span>service<span class="w"> </span>openntpd<span class="w"> </span>start
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>By default, the OpenNTPD service will not listen for time requests, and will use
the Tier-2 servers from <a class="reference external" href="http://www.ntp.org">ntp.org</a> for keeping accurate time. If you want to use
a different time server for synchronization, or use OpenNTPD as a time server,
please see <em>/usr/local/etc/ntpd.org</em>.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
</section></section><section id="adding-a-jail"><h2>Adding a jail</h2>
<p>There are multiple ways to manage your jails, but <a class="reference external" href="http://erdgeist.org/arts/software/ezjail/">ezjail</a> is one of the more
popular ones, probably beacuse it is just so EZ. You can install it from a
binary package:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_23c078383d6b4418b4e157a4c9234dd3-1" name="rest_code_23c078383d6b4418b4e157a4c9234dd3-1" href="#rest_code_23c078383d6b4418b4e157a4c9234dd3-1"></a>sudo<span class="w"> </span>pkg<span class="w"> </span>install<span class="w"> </span>ezjail
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Ezjail works by creating a base jail, and then using that base as the model for
all subsequent jails. Set up the base jail:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_7d4fd354cac24dd385534ebd27207f04-1" name="rest_code_7d4fd354cac24dd385534ebd27207f04-1" href="#rest_code_7d4fd354cac24dd385534ebd27207f04-1"></a>sudo<span class="w"> </span>ezjail-admin<span class="w"> </span>install<span class="w"> </span>-p
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>The -p flag should cause ezjail to include the FreeBSD ports tee in the base jail.
The initial installation of the base jail may take a few minutes.</p>
<section id="setting-up-the-network"><h3>Setting up the network</h3>
<p>You could go ahead and create your jail right off, but the networking will not
work out of the box. Take a minute and do some basic network configuration before
creating your first jail.</p>
<section id="virtual-interface"><h4>Virtual Interface</h4>
<p>In order to keep all of the jails behind a single public IP address, you'll
need to set up a new network interface. This new interface will be a clone
of the loopback interface which will have an IP address assigned to it. You can
you any RFC 1918 address space. In this tutorial, 172.16.1.1 will be used.
Add the following to <em>/etc/rc.conf</em> to get the new interface set up:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_dada019968344c799668643917247b3f-1" name="rest_code_dada019968344c799668643917247b3f-1" href="#rest_code_dada019968344c799668643917247b3f-1"></a># Setup the interface that all jails will use
<a id="rest_code_dada019968344c799668643917247b3f-2" name="rest_code_dada019968344c799668643917247b3f-2" href="#rest_code_dada019968344c799668643917247b3f-2"></a>cloned_interfaces="lo1"
<a id="rest_code_dada019968344c799668643917247b3f-3" name="rest_code_dada019968344c799668643917247b3f-3" href="#rest_code_dada019968344c799668643917247b3f-3"></a>ifconfig_lo1="inet 172.16.1.1 netmask 255.255.255.0"
<a id="rest_code_dada019968344c799668643917247b3f-4" name="rest_code_dada019968344c799668643917247b3f-4" href="#rest_code_dada019968344c799668643917247b3f-4"></a>
<a id="rest_code_dada019968344c799668643917247b3f-5" name="rest_code_dada019968344c799668643917247b3f-5" href="#rest_code_dada019968344c799668643917247b3f-5"></a># Future jails can use the following as a template.
<a id="rest_code_dada019968344c799668643917247b3f-6" name="rest_code_dada019968344c799668643917247b3f-6" href="#rest_code_dada019968344c799668643917247b3f-6"></a># Be sure to use 255.255.255.255 as the netmask for all interface aliases
<a id="rest_code_dada019968344c799668643917247b3f-7" name="rest_code_dada019968344c799668643917247b3f-7" href="#rest_code_dada019968344c799668643917247b3f-7"></a># ifconfig_lo1_alias0="inet 172.16.1.2 netmask 255.255.255.255"
<a id="rest_code_dada019968344c799668643917247b3f-8" name="rest_code_dada019968344c799668643917247b3f-8" href="#rest_code_dada019968344c799668643917247b3f-8"></a>
<a id="rest_code_dada019968344c799668643917247b3f-9" name="rest_code_dada019968344c799668643917247b3f-9" href="#rest_code_dada019968344c799668643917247b3f-9"></a># Enable port forwarding and packet filtering
<a id="rest_code_dada019968344c799668643917247b3f-10" name="rest_code_dada019968344c799668643917247b3f-10" href="#rest_code_dada019968344c799668643917247b3f-10"></a>pf_enable="YES"
<a id="rest_code_dada019968344c799668643917247b3f-11" name="rest_code_dada019968344c799668643917247b3f-11" href="#rest_code_dada019968344c799668643917247b3f-11"></a>
<a id="rest_code_dada019968344c799668643917247b3f-12" name="rest_code_dada019968344c799668643917247b3f-12" href="#rest_code_dada019968344c799668643917247b3f-12"></a># Enable EZJail at startup
<a id="rest_code_dada019968344c799668643917247b3f-13" name="rest_code_dada019968344c799668643917247b3f-13" href="#rest_code_dada019968344c799668643917247b3f-13"></a>ezjail_enable="YES"
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>With those entries in <em>/etc/rc.conf</em> the interfaces will all be created and
configured at boot time. To get the interface set up without a reboot, you can
use the following commands:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_ff3f5f15ee3f4de581a726f764fc4d41-1" name="rest_code_ff3f5f15ee3f4de581a726f764fc4d41-1" href="#rest_code_ff3f5f15ee3f4de581a726f764fc4d41-1"></a>sudo<span class="w"> </span>ifconfig<span class="w"> </span>lo1<span class="w"> </span>create
<a id="rest_code_ff3f5f15ee3f4de581a726f764fc4d41-2" name="rest_code_ff3f5f15ee3f4de581a726f764fc4d41-2" href="#rest_code_ff3f5f15ee3f4de581a726f764fc4d41-2"></a>sudo<span class="w"> </span>ifconfig<span class="w"> </span>lo1<span class="w"> </span>inet<span class="w"> </span><span class="m">172</span>.16.1.1<span class="w"> </span>netmask<span class="w"> </span><span class="m">255</span>.255.255.0
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>An <em>ifconfig</em> should now show a new interface:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_f20430b2060a4c80893bff62bafa7780-1" name="rest_code_f20430b2060a4c80893bff62bafa7780-1" href="#rest_code_f20430b2060a4c80893bff62bafa7780-1"></a>lo1: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
<a id="rest_code_f20430b2060a4c80893bff62bafa7780-2" name="rest_code_f20430b2060a4c80893bff62bafa7780-2" href="#rest_code_f20430b2060a4c80893bff62bafa7780-2"></a>    options=600003&lt;RXCSUM,TXCSUM,RXCSUM_IPV6,TXCSUM_IPV6&gt;
<a id="rest_code_f20430b2060a4c80893bff62bafa7780-3" name="rest_code_f20430b2060a4c80893bff62bafa7780-3" href="#rest_code_f20430b2060a4c80893bff62bafa7780-3"></a>    inet 172.16.1.1 netmask 0xffffff00
<a id="rest_code_f20430b2060a4c80893bff62bafa7780-4" name="rest_code_f20430b2060a4c80893bff62bafa7780-4" href="#rest_code_f20430b2060a4c80893bff62bafa7780-4"></a>    nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
</section><section id="nat-for-packet-forwarding"><h4>NAT for packet forwarding</h4>
<p>Now that you have an interface to use with your jails, you'll need to get some
packet forwarding set up. Edit <em>/etc/pf.conf</em> (which will be empty by default)
according to the following</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_a085ac59bf4d48f9a390d42f68288653-1" name="rest_code_a085ac59bf4d48f9a390d42f68288653-1" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-1"></a>#Define the interfaces
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-2" name="rest_code_a085ac59bf4d48f9a390d42f68288653-2" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-2"></a>ext_if = "vtnet0"
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-3" name="rest_code_a085ac59bf4d48f9a390d42f68288653-3" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-3"></a>int_if = "lo1"
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-4" name="rest_code_a085ac59bf4d48f9a390d42f68288653-4" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-4"></a>jail_net = $int_if:network
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-5" name="rest_code_a085ac59bf4d48f9a390d42f68288653-5" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-5"></a>
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-6" name="rest_code_a085ac59bf4d48f9a390d42f68288653-6" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-6"></a>#Define the NAT for the jails
<a id="rest_code_a085ac59bf4d48f9a390d42f68288653-7" name="rest_code_a085ac59bf4d48f9a390d42f68288653-7" href="#rest_code_a085ac59bf4d48f9a390d42f68288653-7"></a>nat on $ext_if from $jail_net to any -&gt; ($ext_if)
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>The first 3 lines define a couple of useful variables -- called macros in PF parlance.
The <em>nat</em> line instructs PF to mask outbound traffic from the jails (all of them)
behind the IP address of the external interface. In short, all of your outbound
jail traffic will come from the IP address of your droplet.</p>
<p>With that in place, you can start PF:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_7178d39c6fa14672a89f6d9e82414746-1" name="rest_code_7178d39c6fa14672a89f6d9e82414746-1" href="#rest_code_7178d39c6fa14672a89f6d9e82414746-1"></a>sudo<span class="w"> </span>service<span class="w"> </span>pf<span class="w"> </span>start
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Before you load the firewall ruleset, test the config file to ensure that all is
well:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_86d3fcce061444ff973d989b1c6ed7a9-1" name="rest_code_86d3fcce061444ff973d989b1c6ed7a9-1" href="#rest_code_86d3fcce061444ff973d989b1c6ed7a9-1"></a>sudo<span class="w"> </span>pfctl<span class="w"> </span>-nvf<span class="w"> </span>/etc/pf.conf
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>That command will cause PF to parse the rules in <em>/etc/pf.conf</em>, and print them
back out to the console. If there are syntax errors, they will be called out.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_0a05d94c371e429ea601bf703e3f63d0-1" name="rest_code_0a05d94c371e429ea601bf703e3f63d0-1" href="#rest_code_0a05d94c371e429ea601bf703e3f63d0-1"></a>freebsd@hostname:~ % sudo pfctl -nvf /etc/pf.conf
<a id="rest_code_0a05d94c371e429ea601bf703e3f63d0-2" name="rest_code_0a05d94c371e429ea601bf703e3f63d0-2" href="#rest_code_0a05d94c371e429ea601bf703e3f63d0-2"></a>ext_if = "vtnet0"
<a id="rest_code_0a05d94c371e429ea601bf703e3f63d0-3" name="rest_code_0a05d94c371e429ea601bf703e3f63d0-3" href="#rest_code_0a05d94c371e429ea601bf703e3f63d0-3"></a>int_if = "lo1"
<a id="rest_code_0a05d94c371e429ea601bf703e3f63d0-4" name="rest_code_0a05d94c371e429ea601bf703e3f63d0-4" href="#rest_code_0a05d94c371e429ea601bf703e3f63d0-4"></a>jail_net = "lo1:network"
<a id="rest_code_0a05d94c371e429ea601bf703e3f63d0-5" name="rest_code_0a05d94c371e429ea601bf703e3f63d0-5" href="#rest_code_0a05d94c371e429ea601bf703e3f63d0-5"></a>nat on vtnet0 inet from 172.16.1.0/24 to any -&gt; (vtnet0) round-robin
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Your output should look very similar to what is above. Once you are getting output
that inidicates no errors you can turn on the NAT:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_571af656470646dd93231d537446c188-1" name="rest_code_571af656470646dd93231d537446c188-1" href="#rest_code_571af656470646dd93231d537446c188-1"></a>sudo<span class="w"> </span>pfctl<span class="w"> </span>-f<span class="w"> </span>/etc/pf.conf
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
</section></section></section><section id="creating-the-first-jail"><h2>Creating the first jail</h2>
<p>It's time to create &amp; start a jail:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_02d9e19867dc4b99863ea6fd189600db-1" name="rest_code_02d9e19867dc4b99863ea6fd189600db-1" href="#rest_code_02d9e19867dc4b99863ea6fd189600db-1"></a>sudo<span class="w"> </span>ezjail-admin<span class="w"> </span>create<span class="w"> </span>WEBSERVER<span class="w"> </span><span class="m">172</span>.16.1.1
<a id="rest_code_02d9e19867dc4b99863ea6fd189600db-2" name="rest_code_02d9e19867dc4b99863ea6fd189600db-2" href="#rest_code_02d9e19867dc4b99863ea6fd189600db-2"></a>sudo<span class="w"> </span>ezjail-admin<span class="w"> </span>start<span class="w"> </span>WEBSERVER
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Those commands will have a lot of output, and may end with a warning. You can
safely ignore the warnings. The jail needs to be told how to do DNS lookups. The
simple way to solve this is to copy the hosts <em>/etc/resolv.conf</em> into the jail:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_d69f50df24464cbc9f0be34a1d98decb-1" name="rest_code_d69f50df24464cbc9f0be34a1d98decb-1" href="#rest_code_d69f50df24464cbc9f0be34a1d98decb-1"></a>sudo<span class="w"> </span>cp<span class="w"> </span>/etc/resolv.conf<span class="w"> </span>/usr/jails/WEBSERVER/etc/
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Go ahead and jump into the console of our jail:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_49d5003c2d3a4e43a0cb94c9ce7c74b4-1" name="rest_code_49d5003c2d3a4e43a0cb94c9ce7c74b4-1" href="#rest_code_49d5003c2d3a4e43a0cb94c9ce7c74b4-1"></a>sudo<span class="w"> </span>ezjail-admin<span class="w"> </span>console<span class="w"> </span>WEBSERVER
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>There will be a lot of stuff on the console -- very similar to what you should
have seen when you first connected to your Droplet.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_9b422b312e1741eaabceea70746dc470-1" name="rest_code_9b422b312e1741eaabceea70746dc470-1" href="#rest_code_9b422b312e1741eaabceea70746dc470-1"></a>freebsd@hostname:~ % sudo ezjail-admin console WEBSERVER
<a id="rest_code_9b422b312e1741eaabceea70746dc470-2" name="rest_code_9b422b312e1741eaabceea70746dc470-2" href="#rest_code_9b422b312e1741eaabceea70746dc470-2"></a>FreeBSD 10.1-RELEASE (GENERIC) #0 r274401: Tue Nov 11 21:02:49 UTC 2014
<a id="rest_code_9b422b312e1741eaabceea70746dc470-3" name="rest_code_9b422b312e1741eaabceea70746dc470-3" href="#rest_code_9b422b312e1741eaabceea70746dc470-3"></a>
<a id="rest_code_9b422b312e1741eaabceea70746dc470-4" name="rest_code_9b422b312e1741eaabceea70746dc470-4" href="#rest_code_9b422b312e1741eaabceea70746dc470-4"></a>Welcome to FreeBSD!
<a id="rest_code_9b422b312e1741eaabceea70746dc470-5" name="rest_code_9b422b312e1741eaabceea70746dc470-5" href="#rest_code_9b422b312e1741eaabceea70746dc470-5"></a>
<a id="rest_code_9b422b312e1741eaabceea70746dc470-6" name="rest_code_9b422b312e1741eaabceea70746dc470-6" href="#rest_code_9b422b312e1741eaabceea70746dc470-6"></a>Release Notes, Errata: https://www.FreeBSD.org/releases/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-7" name="rest_code_9b422b312e1741eaabceea70746dc470-7" href="#rest_code_9b422b312e1741eaabceea70746dc470-7"></a>Security Advisories:   https://www.FreeBSD.org/security/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-8" name="rest_code_9b422b312e1741eaabceea70746dc470-8" href="#rest_code_9b422b312e1741eaabceea70746dc470-8"></a>FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-9" name="rest_code_9b422b312e1741eaabceea70746dc470-9" href="#rest_code_9b422b312e1741eaabceea70746dc470-9"></a>FreeBSD FAQ:           https://www.FreeBSD.org/faq/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-10" name="rest_code_9b422b312e1741eaabceea70746dc470-10" href="#rest_code_9b422b312e1741eaabceea70746dc470-10"></a>Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-11" name="rest_code_9b422b312e1741eaabceea70746dc470-11" href="#rest_code_9b422b312e1741eaabceea70746dc470-11"></a>FreeBSD Forums:        https://forums.FreeBSD.org/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-12" name="rest_code_9b422b312e1741eaabceea70746dc470-12" href="#rest_code_9b422b312e1741eaabceea70746dc470-12"></a>
<a id="rest_code_9b422b312e1741eaabceea70746dc470-13" name="rest_code_9b422b312e1741eaabceea70746dc470-13" href="#rest_code_9b422b312e1741eaabceea70746dc470-13"></a>Documents installed with the system are in the /usr/local/share/doc/freebsd/
<a id="rest_code_9b422b312e1741eaabceea70746dc470-14" name="rest_code_9b422b312e1741eaabceea70746dc470-14" href="#rest_code_9b422b312e1741eaabceea70746dc470-14"></a>directory, or can be installed later with:  pkg install en-freebsd-doc
<a id="rest_code_9b422b312e1741eaabceea70746dc470-15" name="rest_code_9b422b312e1741eaabceea70746dc470-15" href="#rest_code_9b422b312e1741eaabceea70746dc470-15"></a>For other languages, replace "en" with a language code like de or fr.
<a id="rest_code_9b422b312e1741eaabceea70746dc470-16" name="rest_code_9b422b312e1741eaabceea70746dc470-16" href="#rest_code_9b422b312e1741eaabceea70746dc470-16"></a>
<a id="rest_code_9b422b312e1741eaabceea70746dc470-17" name="rest_code_9b422b312e1741eaabceea70746dc470-17" href="#rest_code_9b422b312e1741eaabceea70746dc470-17"></a>Show the version of FreeBSD installed:  freebsd-version ; uname -a
<a id="rest_code_9b422b312e1741eaabceea70746dc470-18" name="rest_code_9b422b312e1741eaabceea70746dc470-18" href="#rest_code_9b422b312e1741eaabceea70746dc470-18"></a>Please include that output and any error messages when posting questions.
<a id="rest_code_9b422b312e1741eaabceea70746dc470-19" name="rest_code_9b422b312e1741eaabceea70746dc470-19" href="#rest_code_9b422b312e1741eaabceea70746dc470-19"></a>Introduction to manual pages:  man man
<a id="rest_code_9b422b312e1741eaabceea70746dc470-20" name="rest_code_9b422b312e1741eaabceea70746dc470-20" href="#rest_code_9b422b312e1741eaabceea70746dc470-20"></a>FreeBSD directory layout:      man hier
<a id="rest_code_9b422b312e1741eaabceea70746dc470-21" name="rest_code_9b422b312e1741eaabceea70746dc470-21" href="#rest_code_9b422b312e1741eaabceea70746dc470-21"></a>
<a id="rest_code_9b422b312e1741eaabceea70746dc470-22" name="rest_code_9b422b312e1741eaabceea70746dc470-22" href="#rest_code_9b422b312e1741eaabceea70746dc470-22"></a>Edit /etc/motd to change this login announcement.
<a id="rest_code_9b422b312e1741eaabceea70746dc470-23" name="rest_code_9b422b312e1741eaabceea70746dc470-23" href="#rest_code_9b422b312e1741eaabceea70746dc470-23"></a>root@WEBSERVER:~ #
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Notice that your prompt has changed. Congratulations, you are inside your jail!
It's probably a good idea to test your connectivity to the outside world, but
by default, and for security reasons, FreeBSD jails are not allowed to ping. To
test connectivity, you can use telnet:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_028c91c2a62541d49d78a69884db7663-1" name="rest_code_028c91c2a62541d49d78a69884db7663-1" href="#rest_code_028c91c2a62541d49d78a69884db7663-1"></a>telnet<span class="w"> </span>www.digitaloean.com<span class="w"> </span><span class="m">80</span>
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>That command will open up a very basic connection to a webserver at Digital Ocean.
You can get out of it pressing Control-] to close the connection, followed by
<em>quit</em> to close telnet.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-1" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-1" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-1"></a>root@WEBSERVER:~ # telnet www.digitalocean.com 80
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-2" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-2" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-2"></a>Trying 104.16.24.4...
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-3" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-3" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-3"></a>Connected to www.digitalocean.com.
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-4" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-4" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-4"></a>Escape character is '^]'.
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-5" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-5" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-5"></a>^]
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-6" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-6" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-6"></a>telnet&gt; quit
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-7" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-7" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-7"></a>Connection closed.
<a id="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-8" name="rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-8" href="#rest_code_c4bd7ee09d82444988c5d9f3f4e086ac-8"></a>root@WEBSERVER:~ #
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<section id="installing-a-webserver"><h3>Installing a webserver</h3>
<p>With a jail up and connected to the internet, you can go ahead and install a
webserver. You should be inside of your jail for this (remember that you can use
<em>sudo ezjail-admin console WEBSERVER</em> to get into your jail):</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_11ba38b9defd450cb675cb0c79c39f77-1" name="rest_code_11ba38b9defd450cb675cb0c79c39f77-1" href="#rest_code_11ba38b9defd450cb675cb0c79c39f77-1"></a>pkg<span class="w"> </span>install<span class="w"> </span>nginx
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>Since <em>pkg</em> has not yet been run in your jail, it will prompt you to allow it to
install and let it configure itself. Then you will be prompted about installing
the webserver:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-1" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-1" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-1"></a>root@WEBSERVER:~ # pkg install nginx
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-2" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-2" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-2"></a>The package management tool is not yet installed on your system.
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-3" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-3" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-3"></a>Do you want to fetch and install it now? [y/N]: y
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-4" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-4" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-4"></a>Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/freebsd:10:x86:64/latest, please wait...
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-5" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-5" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-5"></a>Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-6" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-6" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-6"></a>[WEBSERVER] Installing pkg-1.4.12...
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-7" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-7" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-7"></a>[WEBSERVER] Extracting pkg-1.4.12: 100%
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-8" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-8" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-8"></a>Message for pkg-1.4.12:
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-9" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-9" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-9"></a> If you are upgrading from the old package format, first run:
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-10" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-10" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-10"></a>
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-11" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-11" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-11"></a>  # pkg2ng
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-12" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-12" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-12"></a>Updating FreeBSD repository catalogue...
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-13" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-13" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-13"></a>[WEBSERVER] Fetching meta.txz: 100%    944 B   0.9kB/s    00:01
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-14" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-14" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-14"></a>[WEBSERVER] Fetching packagesite.txz: 100%    5 MiB   1.8MB/s    00:03
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-15" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-15" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-15"></a>Processing entries: 100%
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-16" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-16" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-16"></a>FreeBSD repository update completed. 23992 packages processed
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-17" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-17" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-17"></a>Updating database digests format: 100%
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-18" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-18" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-18"></a>The following 2 packages will be affected (of 0 checked):
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-19" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-19" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-19"></a>
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-20" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-20" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-20"></a>New packages to be INSTALLED:
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-21" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-21" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-21"></a>    nginx: 1.6.2_1,2
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-22" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-22" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-22"></a>    pcre: 8.35_2
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-23" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-23" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-23"></a>
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-24" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-24" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-24"></a>The process will require 6 MiB more space.
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-25" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-25" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-25"></a>1 MiB to be downloaded.
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-26" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-26" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-26"></a>
<a id="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-27" name="rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-27" href="#rest_code_f110aa2fa21443c7b0f2b0bb69e09e0c-27"></a>Proceed with this action? [y/N]:
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>When you say "Yes", pkg will finish the installation of nginx. Next set nginx to
start when the jail starts, and start it immediately:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_3e04eb1df4264a1895be4ff4ba16011f-1" name="rest_code_3e04eb1df4264a1895be4ff4ba16011f-1" href="#rest_code_3e04eb1df4264a1895be4ff4ba16011f-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'nginx_enable="YES"'</span><span class="w"> </span>&gt;<span class="w"> </span>/etc/rc.conf.d/nginx
<a id="rest_code_3e04eb1df4264a1895be4ff4ba16011f-2" name="rest_code_3e04eb1df4264a1895be4ff4ba16011f-2" href="#rest_code_3e04eb1df4264a1895be4ff4ba16011f-2"></a>service<span class="w"> </span>nginx<span class="w"> </span>start
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
</section><section id="redirecting-the-web-traffic-to-the-webserver"><h3>Redirecting the web traffic to the webserver</h3>
<p>Your web server should now be running, but you can't access it quite yet. Issue an
<em>exit</em> command inside your jail to get back to your host system. Make a couple
of edits to /etc/pf.conf to make it look like this:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-1" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-1" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-1"></a># Define the interfaces
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-2" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-2" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-2"></a>ext_if = "vtnet0"
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-3" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-3" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-3"></a>int_if = "lo1"
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-4" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-4" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-4"></a>jail_net = $int_if:network
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-5" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-5" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-5"></a>
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-6" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-6" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-6"></a># Define the IP address of jails
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-7" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-7" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-7"></a># as well as ports to be allowed redirected
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-8" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-8" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-8"></a>WEBSERVER = "172.16.1.1"
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-9" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-9" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-9"></a>WEBSERVER_TCP_PORTS = "{ 80, 443 }"
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-10" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-10" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-10"></a>
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-11" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-11" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-11"></a># Define the NAT for the jails
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-12" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-12" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-12"></a>nat on $ext_if from $jail_net to any -&gt; ($ext_if)
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-13" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-13" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-13"></a>
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-14" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-14" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-14"></a># Redirect traffic on ports 80 and 443 to the webserver jail
<a id="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-15" name="rest_code_826afdca1d4344e29b0c0e1d2d6f642c-15" href="#rest_code_826afdca1d4344e29b0c0e1d2d6f642c-15"></a>rdr pass on $ext_if inet proto tcp to port $WEBSERVER_TCP_PORTS -&gt; $WEBSERVER
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>A quick <em>sudo pfctl -nf /etc/pf.conf</em> should return nothing, indicating that
there are no syntax errors. You can flush the current rules and reload them:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_d1f60c0ac0894334a09f8d9d5af54c68-1" name="rest_code_d1f60c0ac0894334a09f8d9d5af54c68-1" href="#rest_code_d1f60c0ac0894334a09f8d9d5af54c68-1"></a>sudo pfctl -F all -f /etc/pf.conf
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>To be perfectly clear, that command will flush all of the existing tables and
load up the new rules.</p>
<p>At this point, you should be able to browse to the IP of your Droplet, and get
the default Nginx page:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<img alt="/images/FreeBSD_nginx_default.png" src="../../images/FreeBSD_nginx_default.png"><div class="line-block">
<div class="line"><br></div>
</div>
</section></section><section id="finishing-touches"><h2>Finishing touches</h2>
<p>With a fully functioning jail, there are just 2 things left to do.</p>
<section id="locking-down-the-firewall"><h3>Locking down the firewall</h3>
<p>The way things stand right now, your jail is working, but the host system is pretty
wide-open. If you edit your <em>/etc/pf.conf</em> once more, we can restrict all IB
traffic that is not destined for a jail except for SSH.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-1" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-1" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-1"></a># Define the interfaces
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-2" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-2" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-2"></a>ext_if = "vtnet0"
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-3" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-3" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-3"></a>int_if = "lo1"
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-4" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-4" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-4"></a>jail_net = $int_if:network
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-5" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-5" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-5"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-6" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-6" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-6"></a># Define the IP address of jails
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-7" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-7" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-7"></a># as well as ports to be allowed redirected
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-8" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-8" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-8"></a>WEBSERVER = "172.16.1.1"
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-9" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-9" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-9"></a>WEBSERVER_TCP_PORTS = "{ 80, 443 }"
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-10" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-10" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-10"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-11" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-11" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-11"></a># Define the NAT for the jails
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-12" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-12" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-12"></a>nat on $ext_if from $jail_net to any -&gt; ($ext_if)
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-13" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-13" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-13"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-14" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-14" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-14"></a># Redirect traffic on ports 80 and 443 to the webserver jail
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-15" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-15" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-15"></a>rdr pass on $ext_if inet proto tcp to port $WEBSERVER_TCP_PORTS -&gt; $WEBSERVER
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-16" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-16" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-16"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-17" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-17" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-17"></a># Set the default: block everything
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-18" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-18" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-18"></a>block all
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-19" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-19" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-19"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-20" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-20" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-20"></a># Allow the jail traffic to be translated
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-21" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-21" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-21"></a>pass from { lo0, $jail_net } to any keep state
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-22" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-22" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-22"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-23" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-23" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-23"></a># Allow SSH in to the host
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-24" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-24" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-24"></a>pass in inet proto tcp to $ext_if port ssh
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-25" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-25" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-25"></a>
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-26" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-26" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-26"></a># Allow OB traffic
<a id="rest_code_883d51e9b4d247d7877b9bd44eecf587-27" name="rest_code_883d51e9b4d247d7877b9bd44eecf587-27" href="#rest_code_883d51e9b4d247d7877b9bd44eecf587-27"></a>pass out all keep state
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>As always, test your config changes:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_ceb27e91fbad479a8ec63f7d50096936-1" name="rest_code_ceb27e91fbad479a8ec63f7d50096936-1" href="#rest_code_ceb27e91fbad479a8ec63f7d50096936-1"></a>sudo<span class="w"> </span>pfctl<span class="w"> </span>-nf<span class="w"> </span>/etc/pf.conf
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>If there is output, then fix the indicated errors, and keep running that same
command until the command runs with no output. When you are ready, reload the
firewall rules:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_b2fbd5ea1b1d459e91ebfc0ef7cc514c-1" name="rest_code_b2fbd5ea1b1d459e91ebfc0ef7cc514c-1" href="#rest_code_b2fbd5ea1b1d459e91ebfc0ef7cc514c-1"></a>sudo<span class="w"> </span>pfctl<span class="w"> </span>-f<span class="w"> </span>/etc/pf.conf
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>After that command, you may get disconnected from the server. You should be able
to reconnect without issue.</p>
<div class="line-block">
<div class="line"><br></div>
</div>
</section><section id="tweaking-the-jail"><h3>Tweaking the jail</h3>
<p>Jump back into your jail:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_f4b5a05ed8134c45be4a7a72a9bae6e7-1" name="rest_code_f4b5a05ed8134c45be4a7a72a9bae6e7-1" href="#rest_code_f4b5a05ed8134c45be4a7a72a9bae6e7-1"></a>sudo<span class="w"> </span>ezjail-admin<span class="w"> </span>console<span class="w"> </span>WEBSERVER
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>If you run the <em>date</em> command in your jail, you'll notice that the time zone
might be different from the host's timezone. You can fix that by running:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code bash"><a id="rest_code_65ea99e6240c4705b0f04385d9b0e40a-1" name="rest_code_65ea99e6240c4705b0f04385d9b0e40a-1" href="#rest_code_65ea99e6240c4705b0f04385d9b0e40a-1"></a>tzsetup
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>from within the jail. It is the same process as you already went through earlier
when you set up the timesone for the host.</p>
<p>While you are in the jail, you should probably add the following lines to
<em>/etc/rc.conf</em> as well:</p>
<div class="line-block">
<div class="line"><br></div>
</div>
<div class="code"><pre class="code text"><a id="rest_code_bf73a8c089204f2cbb19b2d587c39434-1" name="rest_code_bf73a8c089204f2cbb19b2d587c39434-1" href="#rest_code_bf73a8c089204f2cbb19b2d587c39434-1"></a>rpcbind_enable="NO"             # Disable the RPC daemon
<a id="rest_code_bf73a8c089204f2cbb19b2d587c39434-2" name="rest_code_bf73a8c089204f2cbb19b2d587c39434-2" href="#rest_code_bf73a8c089204f2cbb19b2d587c39434-2"></a>cron_flags="$cron_flags -J 15"  # Prevent lots of jails running cron jobs at the same time
<a id="rest_code_bf73a8c089204f2cbb19b2d587c39434-3" name="rest_code_bf73a8c089204f2cbb19b2d587c39434-3" href="#rest_code_bf73a8c089204f2cbb19b2d587c39434-3"></a>syslogd_flags="-ss"             # Disable syslogd listening for incoming connections
<a id="rest_code_bf73a8c089204f2cbb19b2d587c39434-4" name="rest_code_bf73a8c089204f2cbb19b2d587c39434-4" href="#rest_code_bf73a8c089204f2cbb19b2d587c39434-4"></a>sendmail_enable="NONE"          # Completely disable sendmail
<a id="rest_code_bf73a8c089204f2cbb19b2d587c39434-5" name="rest_code_bf73a8c089204f2cbb19b2d587c39434-5" href="#rest_code_bf73a8c089204f2cbb19b2d587c39434-5"></a>clear_tmp_enable="YES"          # Clear /tmp at startup
</pre></div>
<div class="line-block">
<div class="line"><br></div>
</div>
<p>As you can see, they are basic commands for keeping your jail in order.</p>
</section></section><section id="moving-forward"><h2>Moving Forward</h2>
<p>With the first jail out of the way, you can continue to add jails as you need them.
The high level steps would be along these lines:</p>
<ol class="arabic simple">
<li><p>Create a new lo1 alias with a unique IP address in <em>/etc/rc.conf</em></p></li>
<li><p>Define the jail in <em>/etc/pf.conf</em>, including the IP, ports to be redirected, and the redirect rules.</p></li>
<li><p>Create the jail</p></li>
</ol>
<p>Welcome to the world of FreeBSD Jails.</p>
</section>
</div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="next">
                <a href="../building-an-openvpn-server-with-opnsense/" rel="next" title="Building an OpenVPN Server with OPNSense">Next post</a>
            </li>
        </ul></nav></aside><footer id="footer"><p>
Contents  2026         <a href="mailto:kirk@kirkg.us">Kirk Gleason</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a><br><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.5/ar/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/2.5/ar/88x31.png"></a>

<a title="Web Analytics" href="http://clicky.com/101017846"><img alt="Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0"></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script><script type="text/javascript">try{ clicky.init(101017846); }catch(e){}</script><noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101017846ns.gif"></p></noscript>

</p>
            
        </footer></article>
</div>
	</section><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>

    moment.locale("en");
    fancydates(1, "YYYY-MM-DD HH:mm");

	</script><!-- end fancy dates --><script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});

	</script><script src="../../assets/js/ToggleNav.js">
	</script>
</body>
</html>
